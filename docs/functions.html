<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Functions | Preceptor’s Primer for Bayesian Data Science</title>
<meta name="author" content="David Kane">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.8/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.5.1/tabs.js"></script><script src="libs/bs3compat-0.2.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><script src="libs/plotly-binding-4.9.3/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css-1.57.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-1.57.1/plotly-latest.min.js"></script><script src="libs/rglWebGL-binding-0.106.8/rglWebGL.js"></script><link href="libs/rglwidgetClass-0.106.8/rgl.css" rel="stylesheet">
<script src="libs/rglwidgetClass-0.106.8/rglClass.min.js"></script><script src="libs/CanvasMatrix4-0.106.8/CanvasMatrix.min.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Preceptor’s Primer for Bayesian Data Science</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preamble.html">Preamble</a></li>
<li><a class="" href="getting-started.html">Getting Started</a></li>
<li><a class="" href="visualization.html"><span class="header-section-number">1</span> Visualization</a></li>
<li><a class="" href="wrangling.html"><span class="header-section-number">2</span> Wrangling</a></li>
<li><a class="" href="data.html"><span class="header-section-number">3</span> Data</a></li>
<li><a class="" href="rubin-causal-model.html"><span class="header-section-number">4</span> Rubin Causal Model</a></li>
<li><a class="" href="probability.html"><span class="header-section-number">5</span> Probability</a></li>
<li><a class="" href="one-parameter.html"><span class="header-section-number">6</span> One Parameter</a></li>
<li><a class="" href="two-parameters.html"><span class="header-section-number">7</span> Two Parameters</a></li>
<li><a class="" href="three-parameters.html"><span class="header-section-number">8</span> Three Parameters</a></li>
<li><a class="" href="four-parameters.html"><span class="header-section-number">9</span> Four Parameters</a></li>
<li><a class="" href="five-parameters.html"><span class="header-section-number">10</span> Five Parameters</a></li>
<li><a class="" href="n-parameters.html"><span class="header-section-number">11</span> N Parameters</a></li>
<li><a class="" href="tools.html">Tools</a></li>
<li><a class="active" href="functions.html">Functions</a></li>
<li><a class="" href="maps.html">Maps</a></li>
<li><a class="" href="ipums.html">IPUMS</a></li>
<li><a class="" href="animation.html">Animation</a></li>
<li><a class="" href="set-up-for-working-on-the-primer.html">Set Up for Working on The Primer</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/PPBDS/primer">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="functions" class="section level1 unnumbered">
<h1>Functions<a class="anchor" aria-label="anchor" href="#functions"><i class="fas fa-link"></i></a>
</h1>
<!-- Get rid of nhanes example as too confusing? -->
<!-- Get rid of anonymous function section as too confusing? Or save it for final section of Advanced stuff? -->
<!-- The functions created here should be more tightly connected to the functions created in the tutorial. Recall that we will be merging the tutorial into the chapter this summer, I hope! -->
<!-- And we also want to lay the groundwork for the problem set (and exam) which require writing a function. And, finally, all these exercises should be teaching something which is then referenced in probability and in stan_glm. Yet it is not clear what those would be. Maybe some simulations? -->
<!-- If the Democrats have a 50% chance of winning each seat in the Senate, what are the odds of them getting 60 seats (to beat the filibuster) at any one time? How much does their advantage have to be to have a 20% chance of getting 60? Do this first while pretending that all senates run each two years. Then do it staggered. Or is all that too complex? -->
<!-- Maybe an advanced form of the guessing game in which we are allowed to provide a function. The goal of inference is to come up with a function which wins the prediction game. -->
<!-- This is currently in problem set #3: Change the objective function. The simplest form of the Guessing Game just counts each contest separately. A more advanced for would give you a penalty which varies depending on how wrong you are. (This, obviously, is one way to think about minimizing the squared residuals.) This is very fun because there are many different penalty functions, each of which may lead to a different function winning the Guessing Game. -->
<!-- Another form of the Guessing Game is like a casino. One person (the Casino) gives a 50% confidence interval. The other person gets to pick either inside or outside. Then there is a draw. The Casino wins if the second person can't consistently win. -->
<div id="introduction-1" class="section level2" number="11.7">
<h2>
<span class="header-section-number">11.7</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-1"><i class="fas fa-link"></i></a>
</h2>
<p>A function is a piece of code that is packaged in a way that makes it easy to reuse. Functions make it easy for you to <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>, and create a <code>tibble()</code>, as you have seen in Chapters <a href="visualization.html#visualization">1</a> and <a href="wrangling.html#wrangling">2</a>. Functions also allow you to transform variables and perform mathematical calculations. We use functions like <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code> and <code><a href="https://rdrr.io/r/stats/Uniform.html">runif()</a></code> to generate random draws from a distribution.</p>
<p>Every time we reference a function in this <em>Primer</em>, we include the parentheses. You call a function by including its parentheses and any necessary arguments within those parentheses. This is a correct call of <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code>:</p>
<div class="sourceCode" id="cb952"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.33</code></pre>
<p>If you run the function name without its parentheses, R will return the code that makes up the function.</p>
<div class="sourceCode" id="cb954"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rnorm</span></code></pre></div>
<pre><code>## function (n, mean = 0, sd = 1) 
## .Call(C_rnorm, n, mean, sd)
## &lt;bytecode: 0x7ffabd6837d8&gt;
## &lt;environment: namespace:stats&gt;</code></pre>
<p>Functions can do all sorts of things. <code><a href="https://rdrr.io/r/base/sample.html">sample()</a></code> takes a vector of values and returns a number of values randomly selected from that vector. You can specify the number of random values with the argument <code>size</code>. This call is the equivalent of rolling a die.</p>
<div class="sourceCode" id="cb956"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>Functions can also take in other functions as arguments. For example, <code><a href="https://rdrr.io/r/base/lapply.html">replicate()</a></code> takes an expression and repeats it <code>n</code> times. What if we replicated the rolling of a die ten times?</p>
<div class="sourceCode" id="cb958"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] 5 4 6 1 3 5 3 4 1 3</code></pre>
<p>An especially useful type of function is the family of <code>map_*</code> functions, from the <strong>purrr</strong> package, which is automatically loaded with <code><a href="https://tidyverse.tidyverse.org">library(tidyverse)</a></code>. These functions apply some other function to every row in a tibble.</p>
<div class="sourceCode" id="cb960"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></code></pre></div>
<p>Let’s create a tibble with one variable <code>x</code> which takes on three values: 3, 7, and 2.</p>
<div class="sourceCode" id="cb961"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 1
##       x
##   &lt;dbl&gt;
## 1     4
## 2    16
## 3     9</code></pre>
<p>It is easy to use mutate to create a new variable, <code>sq_root</code>, which is the square root of each value of x.</p>
<div class="sourceCode" id="cb963"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sq_root <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##       x sq_root
##   &lt;dbl&gt;   &lt;dbl&gt;
## 1     4       2
## 2    16       4
## 3     9       3</code></pre>
<p><code>map_*</code> functions provide another approach. A <code>map_*</code> function takes two required arguments. First is the object over which you want to iterate. This will generally be a column in the tibble in which you are working. Second is the function which you want to run for each row in the tibble.</p>
<div class="sourceCode" id="cb965"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sq_root <span class="op">=</span> <span class="fu">map_dbl</span><span class="op">(</span><span class="va">x</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##       x sq_root
##   &lt;dbl&gt;   &lt;dbl&gt;
## 1     4       2
## 2    16       4
## 3     9       3</code></pre>
<p><code>map_dbl()</code> (pronounced “map-double”) took the function <code><a href="https://rdrr.io/r/base/MathFun.html">sqrt()</a></code> and applied it to each element of <code>x</code>. There are two tricky parts to the use of map_* functions. First, you need to put the tilde symbol — the “~” — before the name of the function which you want to call. Without the <code><a href="https://rdrr.io/r/base/tilde.html">~</a></code>, you will get an error:</p>
<div class="sourceCode" id="cb967"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sq_root <span class="op">=</span> <span class="fu">map_dbl</span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Error: Problem with `mutate()` column `sq_root`.
## ℹ `sq_root = map_dbl(x, sqrt(.))`.
## x Can't convert a `tbl_df/tbl/data.frame` object to function</code></pre>
<p>Second, you need to include a period — the “.” — in the spot where the variable goes. Using the name of the variable — <code>x</code> in this case — will generate an error.</p>
<div class="sourceCode" id="cb969"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sq_root <span class="op">=</span> <span class="fu">map_dbl</span><span class="op">(</span><span class="va">x</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Error: Problem with `mutate()` column `sq_root`.
## ℹ `sq_root = map_dbl(x, ~sqrt(x))`.
## x Result 1 must be a single double, not a double vector of length 3</code></pre>
<p><em>Tilde and dot (<code><a href="https://rdrr.io/r/base/tilde.html">~</a></code> and <code>.</code>) are easy to forget.</em></p>
<p>If you know the expected output of your function, you can specify that kind of vector:</p>
<ul>
<li>
<code>map()</code>: list<br>
</li>
<li>
<code>map_lgl()</code>: logical</li>
<li>
<code>map_int()</code>: integer</li>
<li>
<code>map_dbl()</code>: double (numeric)</li>
<li>
<code>map_chr()</code>: character</li>
<li>
<code>map_df()</code>: data frame</li>
</ul>
<p>Since our example returns numeric output, we use <code>map_dbl()</code> instead of <code>map()</code>.</p>
<p>The key difference between using <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> and <code>map_*</code> functions is that <code>map_*</code> functions are designed to work well with lists, both as inputs and as outputs. <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> is designed for atomic vectors, meaning vectors in which element is a single value.</p>
</div>
<div id="list-columns-and-map-functions-1" class="section level2" number="11.8">
<h2>
<span class="header-section-number">11.8</span> List-columns and map functions<a class="anchor" aria-label="anchor" href="#list-columns-and-map-functions-1"><i class="fas fa-link"></i></a>
</h2>
<p>Recall that a list is different from an atomic vector. In atomic vectors, each element of the vector has one value. Lists, however, can contain vectors, and even more complex objects, as elements.</p>
<div class="sourceCode" id="cb971"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"Z"</span><span class="op">)</span><span class="op">)</span>
<span class="va">x</span></code></pre></div>
<pre><code>## [[1]]
## [1]  4 16  9
## 
## [[2]]
## [1] "A" "Z"</code></pre>
<p><code>x</code> is a list with two elements. That element is a numeric vector of length 3. The second element is a character vector of length 2. We use <code>[[]]</code> to extract specific elements. Example:</p>
<div class="sourceCode" id="cb973"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></code></pre></div>
<pre><code>## [1] 9</code></pre>
<p>The first <code>[[]]</code> extracts the first element form the list <code>x</code>. The second `[[]]`` extracts the 3rd element from the vector which is that first element.</p>
<p>There are a number of built-in R functions that output lists. For example, the <strong><em>ggplot</em></strong> objects you have been making store all of the plot information in lists. Any function that returns multiple values can be used to create a list output by wrapping that returned object with <code><a href="https://rdrr.io/r/base/list.html">list()</a></code>.</p>
<div class="sourceCode" id="cb975"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>

<span class="co"># range() returns the min and max of the argument </span>

<span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] -1.0  1.3</code></pre>
<div class="sourceCode" id="cb977"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>col_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<pre><code>## # A tibble: 1 x 1
##   col_1    
##   &lt;list&gt;   
## 1 &lt;dbl [2]&gt;</code></pre>
<p>Notice this is a 1x1 tibble with one observation, which is a list of one element. Voila! You have just created a <strong>list-column</strong>.</p>
<p><em>If a function returns multiple values as a vector, like <code><a href="https://rdrr.io/r/base/range.html">range()</a></code> does, you must use <code><a href="https://rdrr.io/r/base/list.html">list()</a></code> as a wrapper if you want to create a list-column.</em></p>
<p>A list column is a column of your data which is a <a href="https://adv-r.hadley.nz/vectors-chap.html#lists">list</a> rather than an atomic vector. Like with lists, you can pipe to <code><a href="https://rdrr.io/r/utils/str.html">str()</a></code> to examine the column.</p>
<div class="sourceCode" id="cb979"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>col_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## tibble [1 × 1] (S3: tbl_df/tbl/data.frame)
##  $ col_1:List of 1
##   ..$ : num [1:2] -1.02 1.33</code></pre>
<p>We can use <code>map_*</code> functions to both create a list-column and then, much more importantly, work with that list-column afterwards. Example:</p>
<!-- DK: This is a good example. Needs to go slower, or be repeated several times. -->
<div class="sourceCode" id="cb981"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This simple example demonstrates the workflow which we will often follow.</span>
<span class="co"># Start by creating a tibble which will be used to store the results. (Or start</span>
<span class="co"># with a tibble which already exists and to which you will be adding more</span>
<span class="co"># columns.) It is often convenient to get all the code working with just a few</span>
<span class="co"># rows. Once it is working, we increase the number of rows to a thousand or</span>
<span class="co"># million or whatever we need.</span>

<span class="fu">tibble</span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  
  <span class="co"># The big convenience is being able to store a list in each row of the tibble.</span>
  <span class="co"># Note that we are not using the value of ID in the call to rnorm(). (That is</span>
  <span class="co"># why we don't have a "." anywhere.) But we are still using ID as a way of</span>
  <span class="co"># iterating through each row; ID is keeping count for us, in a sense.</span>
  
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>draws <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  
  <span class="co"># Each succeeding step of the pipe works with columns already in the tibble</span>
  <span class="co"># while, in general, adding more columns. The next step calculates the max</span>
  <span class="co"># value in each of the draw vectors. We use map_dbl() because we know that</span>
  <span class="co"># max() will returns a single number.</span>
  
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>max <span class="op">=</span> <span class="fu">map_dbl</span><span class="op">(</span><span class="va">draws</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  
  <span class="co"># We will often need to calculate more than one item from a given column like</span>
  <span class="co"># draws. For example, in addition to knowing the max value, we would like to</span>
  <span class="co"># know the range. Because the range is a vector, we need to store the result</span>
  <span class="co"># in a list column. map() does that for us automatically.</span>
  
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>min_max <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">draws</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 4
##      ID draws        max min_max  
##   &lt;int&gt; &lt;list&gt;     &lt;dbl&gt; &lt;list&gt;   
## 1     1 &lt;dbl [10]&gt; 2.38  &lt;dbl [2]&gt;
## 2     2 &lt;dbl [10]&gt; 0.944 &lt;dbl [2]&gt;
## 3     3 &lt;dbl [10]&gt; 1.29  &lt;dbl [2]&gt;</code></pre>
<p>This flexibility is only possible via the use of list-columns and <code>map_*</code> functions. This workflow is extremely common. We start with an empty tibble, using ID to specify the number of rows. With that skeleton, each step of the pipe adds a new column, working off a column which already exists.</p>
<!-- DK: Is this a good example? A good transition? Whole thing should go slower, with more examples. Need to be redone along with a redo of Functions A tutorial. -->
<p>Let’s practice with the <code>nhanes</code> dataset from the <strong>primer.data</strong> package. How could we add a column to the dataset that included the quantiles of the <code>height</code> variable for each <code>gender</code>?</p>
<div class="sourceCode" id="cb983"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">primer.data</span><span class="op">)</span></code></pre></div>
<p>Select the relevant variables, and group by <code>gender</code>. We are grouping because we are curious as to how <code>height</code> is distributed in between <code>gender</code>. We drop any rows with missing data.</p>
<div class="sourceCode" id="cb984"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nhanes</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gender</span>, <span class="va">height</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 9,647 x 2
## # Groups:   gender [2]
##    gender height
##    &lt;chr&gt;   &lt;dbl&gt;
##  1 Male     165.
##  2 Male     165.
##  3 Male     165.
##  4 Male     105.
##  5 Female   168.
##  6 Male     133.
##  7 Male     131.
##  8 Female   167.
##  9 Female   167.
## 10 Female   167.
## # … with 9,637 more rows</code></pre>
<p>There are two approaches. In the first, we are happy to have an output tibble with just two rows:</p>
<div class="sourceCode" id="cb986"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nhanes</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gender</span>, <span class="va">height</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>q_height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span>,
            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##   gender q_height 
##   &lt;chr&gt;  &lt;list&gt;   
## 1 Female &lt;dbl [5]&gt;
## 2 Male   &lt;dbl [5]&gt;</code></pre>
<p>Note that there was no need to use <code>map_*</code> functions in this case. The simple <strong>dplyr</strong> approach works fine. The only “trick” is the use of <code><a href="https://rdrr.io/r/base/list.html">list()</a></code> to wrap the output of <code><a href="https://rdrr.io/r/stats/quantile.html">quantile()</a></code>. Use <code><a href="https://rdrr.io/r/utils/str.html">str()</a></code> to examine the exact values.</p>
<div class="sourceCode" id="cb988"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nhanes</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gender</span>, <span class="va">height</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>q_height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span>,
            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## tibble [2 × 2] (S3: tbl_df/tbl/data.frame)
##  $ gender  : chr [1:2] "Female" "Male"
##  $ q_height:List of 2
##   ..$ : Named num [1:5] 83.8 154.3 160.6 165.9 184.5
##   .. ..- attr(*, "names")= chr [1:5] "0%" "25%" "50%" "75%" ...
##   ..$ : Named num [1:5] 83.6 166.2 173.8 179.4 200.4
##   .. ..- attr(*, "names")= chr [1:5] "0%" "25%" "50%" "75%" ...</code></pre>
<p>Men are taller than women throughout the distribution, but the smallest individual (child) in the data, see the 0% quantile, happens to be male.</p>
<p>The second case involves a scenario in which we do not want to “lose” any rows in our tibble. We want a <code>q_height</code> column for all the rows, even if the values included are repetitive. A common scenario is that we want to use <code>q_height</code> to perform a calculation for each individual. To do this, we need a <code>map_*</code> function.</p>
<div class="sourceCode" id="cb990"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nhanes</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gender</span>, <span class="va">height</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">summarize</span><span class="op">(</span>q_height <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">height</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>,
            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 9,647 x 2
##    gender q_height 
##    &lt;chr&gt;  &lt;list&gt;   
##  1 Female &lt;dbl [5]&gt;
##  2 Female &lt;dbl [5]&gt;
##  3 Female &lt;dbl [5]&gt;
##  4 Female &lt;dbl [5]&gt;
##  5 Female &lt;dbl [5]&gt;
##  6 Female &lt;dbl [5]&gt;
##  7 Female &lt;dbl [5]&gt;
##  8 Female &lt;dbl [5]&gt;
##  9 Female &lt;dbl [5]&gt;
## 10 Female &lt;dbl [5]&gt;
## # … with 9,637 more rows</code></pre>
<p>The first four lines of the pipe are the same in both cases. The only difference is the use of <code><a href="https://rdrr.io/r/base/list.html">list(quantile(height))</a></code> in the first and <code>map(height, ~ quantile(.)</code> in the second.</p>
<p>Until now, we have practiced using <code>map_*</code> functions with built-in R functions. Sometimes, however, there is not an R function which does what we want. When that happens, we need to create our own function.</p>
</div>
<div id="custom-functions" class="section level2" number="11.9">
<h2>
<span class="header-section-number">11.9</span> Custom Functions<a class="anchor" aria-label="anchor" href="#custom-functions"><i class="fas fa-link"></i></a>
</h2>
<p>There are many built-in functions in R. A function is composed of a name, a list of arguments and a body. We create our own functions with the <code>function()</code> function.</p>
<div id="creating-your-own-functions" class="section level3" number="11.9.1">
<h3>
<span class="header-section-number">11.9.1</span> Creating your own functions<a class="anchor" aria-label="anchor" href="#creating-your-own-functions"><i class="fas fa-link"></i></a>
</h3>
<p>Assume we want to create a function which adds 1 and 1 together. The first step is to write some R code which does that.</p>
<div class="sourceCode" id="cb992"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span></code></pre></div>
<pre><code>## [1] 2</code></pre>
<p>This code will become the “body” of the function, the part in between the curly braces. We also need to a function definition, which is composed of the name of the function, a call to the <code>function()</code> function, and a pair of curly braces.</p>
<div class="sourceCode" id="cb994"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">add_one_and_one</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span><span class="op">}</span></code></pre></div>
<p>Combining the function definition and the body of the function completes the process.</p>
<div class="sourceCode" id="cb995"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">add_one_and_one</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span>
<span class="op">}</span>

<span class="fu">add_one_and_one</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 2</code></pre>
<p>You just created a function! This function will return <code>1 + 1</code> whenever called.</p>
<p>Consider a function which adds the number 6 to a value <code>x</code>, a value which we want to allow the user provide.</p>
<div class="sourceCode" id="cb997"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">add_six_to_something</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="va">x</span> <span class="op">+</span> <span class="fl">6</span>
<span class="op">}</span>

<span class="fu">add_six_to_something</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 7</code></pre>
<p>You have incorporated your first <strong>formal argument</strong>. Formal arguments in functions are additional parameters that allow the user to customize the use of the function. Instead of adding <code>1 + 1</code> over and over again, your function takes in a number <code>x</code> that the user defines and adds 6. Consider a function with <em>two</em> formal arguments.</p>
<div class="sourceCode" id="cb999"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">add_x_to_y</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">+</span> <span class="va">y</span>
<span class="op">}</span>

<span class="fu">add_x_to_y</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 3</code></pre>
<div class="sourceCode" id="cb1001"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">add_x_to_y</span><span class="op">(</span><span class="fl">4</span>, <span class="fl">3</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 7</code></pre>
</div>
<div id="anonymous-functions-with-map_-functions" class="section level3" number="11.9.2">
<h3>
<span class="header-section-number">11.9.2</span> Anonymous functions with <code>map_*</code> functions<a class="anchor" aria-label="anchor" href="#anonymous-functions-with-map_-functions"><i class="fas fa-link"></i></a>
</h3>
<p>We can create functions that perform operations “on the fly,” without bothering to give them a name. These nameless functions are called <a href="https://coolbutuseless.github.io/2019/03/13/anonymous-functions-in-r-part-1/">anonymous functions.</a></p>
<p>You can use anonymous functions in conjunction with the <code>map_*</code> family of functions. This is probably the most common use of anonymous functions, at least in this <em>Primer</em>.</p>
<p>You can call an anonymous function using a <code><a href="https://rdrr.io/r/base/tilde.html">~</a></code> operator and then using a <code>.</code> to represent the current element. Consider these three approaches:</p>
<div class="sourceCode" id="cb1003"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>new_1 <span class="op">=</span> <span class="va">old</span> <span class="op">+</span> <span class="fl">6</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>new_2 <span class="op">=</span> <span class="fu">map_dbl</span><span class="op">(</span><span class="va">old</span>, <span class="op">~</span> <span class="fu">add_six_to_something</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>new_3 <span class="op">=</span> <span class="fu">map_dbl</span><span class="op">(</span><span class="va">old</span>, <span class="op">~</span> <span class="op">(</span><span class="va">.</span> <span class="op">+</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 4
##     old new_1 new_2 new_3
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     4    10    10    10
## 2    16    22    22    22
## 3     9    15    15    15</code></pre>
<!-- DK: Explicitly show how rnorm() won't work with just mutate because you get the same answer. -->
<p>All three produce the same answer, as we would expect. Just using <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> is best, as long as it accomplishes your goal. In complex situations, especially those involving simulation, it often won’t. Example:</p>
<div class="sourceCode" id="cb1005"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##      ID      x
##   &lt;int&gt;  &lt;dbl&gt;
## 1     1 -0.282
## 2     2 -0.282
## 3     3 -0.282</code></pre>
<p>Calling <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm()</a></code>, or any function with a random component, does not have the effect which you probably want if you do it in the context of a simple <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>. Instead, R runs <code><a href="https://rdrr.io/r/stats/Normal.html">rnorm(1)</a></code> once, and then copies the value generated to the remaining two rows of the tibble. To get a different value in each row, you need to explicitly tell R to do that by using a <code>map_*</code> function:</p>
<div class="sourceCode" id="cb1007"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu">map_dbl</span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##      ID      x      y
##   &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1     1 -0.282 -1.31 
## 2     2 -0.282  0.795
## 3     3 -0.282  0.270</code></pre>
<p>Note that the parentheses in the anonymous function are not necessary. As long as everything after the <code><a href="https://rdrr.io/r/base/tilde.html">~</a></code> works as R code, the anonymous function should work, each time replacing the <code>.</code> with the value in the relevant row from the <code>.x</code> variable — which is <code>old</code> in this case.</p>
<div class="sourceCode" id="cb1009"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>new <span class="op">=</span> <span class="fu">map_dbl</span><span class="op">(</span><span class="va">old</span>, <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##     old   new
##   &lt;dbl&gt; &lt;dbl&gt;
## 1     4     5
## 2    16    17
## 3     9    10</code></pre>
</div>
<div id="skateboard-perfectly-formed-rear-view-mirror" class="section level3" number="11.9.3">
<h3>
<span class="header-section-number">11.9.3</span> Skateboard &gt;&gt; perfectly formed rear-view mirror<a class="anchor" aria-label="anchor" href="#skateboard-perfectly-formed-rear-view-mirror"><i class="fas fa-link"></i></a>
</h3>
<!-- DK: Cut this or explain it. Too confusing/useless for beginners. -->
<p>This image — widely attributed to the Spotify development team — conveys an important point.</p>
<div class="figure" style="text-align: center">
<span id="fig:unnamed-chunk-832"></span>
<img src="functions/images/mvp.jpg" alt="From [Your ultimate guide to Minimum Viable Product (+great examples)](https://blog.fastmonkeys.com/2014/06/18/minimum-viable-product-your-ultimate-guide-to-mvp-great-examples/)" width="60%"><p class="caption">
FIGURE 11.5: From <a href="https://blog.fastmonkeys.com/2014/06/18/minimum-viable-product-your-ultimate-guide-to-mvp-great-examples/">Your ultimate guide to Minimum Viable Product (+great examples)</a>
</p>
</div>
<p>Build that skateboard before you build the car or some fancy car part. A limited-but-functioning thing is very useful. It also keeps spirits high.</p>
<p>This is related to the Telescope Rule:</p>
<blockquote>
<p>It is faster to make a four-inch mirror and then a six-inch mirror than it is to make a six-inch mirror.</p>
</blockquote>
</div>
</div>
<div id="no_na_sampler" class="section level2" number="11.10">
<h2>
<span class="header-section-number">11.10</span> <code>no_NA_sampler()</code><a class="anchor" aria-label="anchor" href="#no_na_sampler"><i class="fas fa-link"></i></a>
</h2>
<p>Assume that we want to sample 10 observations for <code>height</code> from the <code>nhanes</code> tibble from the <strong>primer.data</strong> package. That is easy to do with the built in function <code><a href="https://rdrr.io/r/base/sample.html">sample()</a></code>.</p>
<div class="sourceCode" id="cb1011"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">nhanes</span><span class="op">$</span><span class="va">height</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] 159 119 170 171 181 136  99 169 153 175</code></pre>
<p>One problem with this approach is that it will sample missing values of <code>height</code>. We can avoid that by manipulating the vector inside of the call to <code><a href="https://rdrr.io/r/base/sample.html">sample()</a></code>.</p>
<div class="sourceCode" id="cb1013"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">nhanes</span><span class="op">$</span><span class="va">height</span><span class="op">[</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nhanes</span><span class="op">$</span><span class="va">height</span><span class="op">)</span><span class="op">]</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] 163 141 158 160 169 183 117 158  86 176</code></pre>
<p>That works, but, first, it is ugly code. And, second, it is hard to extend when we have more constraints. For example, assume we only want to sample from individuals who have no missing values for any variables, not just <code>height</code>. To do that, we really ought to make a custom function. Call that function <code>no_NA_sampler()</code>.</p>
<p>The first step in function creation is to write code in a normal pipe which does what you want the function to do. In this case, that code would look like:</p>
<div class="sourceCode" id="cb1015"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nhanes</span> <span class="op">%&gt;%</span> 
  <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">slice_sample</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">pull</span><span class="op">(</span><span class="va">height</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] 157 166 171 160 156 152 166 150 175 160</code></pre>
<p>We start with <code>nhanes</code>, use <code>drop_na()</code> to remove rows with missing values for any variable, sample 10 rows at random and then pull out <code>height</code>. To turn this into a function, we just need to copy/paste this pipe within the body of our function definition:</p>
<div class="sourceCode" id="cb1017"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">no_NA_sampler</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="va">nhanes</span> <span class="op">%&gt;%</span> 
    <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">slice_sample</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu">pull</span><span class="op">(</span><span class="va">height</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">no_NA_sampler</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] 162 165 159 156 159 160 157 171 164 156</code></pre>
<p>Voila! A function just executes the code within its body. <em>The first step in building a function is not to write the function. It is to write the code which you want the function to execute.</em></p>
<p>The first version, however, “hard codes” a lot of options which we might want to change. What if we want to sample 5 values of height or 500? In that case, we could hard code a new number in place of “10.” A better option would be to add an argument so that we can pass in whatever value we want.</p>
<div class="sourceCode" id="cb1019"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">no_NA_sampler</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">{</span>
  <span class="va">nhanes</span> <span class="op">%&gt;%</span> 
    <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">slice_sample</span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu">pull</span><span class="op">(</span><span class="va">height</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">no_NA_sampler</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 164 170</code></pre>
<div class="sourceCode" id="cb1021"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">no_NA_sampler</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] 156 172 166 168 166 164 164 161 159 156 163 164 168 170 155 177 173 166 169
## [20] 173 174 157 159 157 159</code></pre>
<p>What if we want to sample from a different variable than <code>height</code> or from a different tibble than <code>nhanes</code>? Again, the trick is to turn hard coded values into arguments. The argument <code>tbl</code> is a placeholder for a data set, <code>n</code> for the number of samples you want extracted from your data set, and <code>var</code> for the variable in the samples that we are studying.</p>
<div class="sourceCode" id="cb1023"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">no_NA_sampler</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tbl</span>, <span class="va">var</span>, <span class="va">n</span><span class="op">)</span><span class="op">{</span>
  <span class="va">tbl</span> <span class="op">%&gt;%</span> 
    <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">slice_sample</span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu">pull</span><span class="op">(</span><span class="op">{</span><span class="op">{</span><span class="va">var</span><span class="op">}</span><span class="op">}</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">no_NA_sampler</span><span class="op">(</span>tbl <span class="op">=</span> <span class="va">nhanes</span>, var <span class="op">=</span> <span class="va">height</span>, n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 164 163</code></pre>
<p>R does not know how to interpret something like <code>age</code> when it is passed in an argument. The double curly braces around <code>var</code> tell R, in essence, that <code>var</code> is a variable in the tibble created from sampling from our input tibble <code>tbl</code>. We can use the order of the arguments, without naming them, with <code>no_NA_sampler()</code>, just as with any other R function:</p>
<div class="sourceCode" id="cb1025"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">trains</span>, <span class="va">age</span>, <span class="fl">5</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 45 42 41 31 44</code></pre>
<!-- DK: I realize that the above is a lousy explanation. Feel free to change it completely. -->
<p>Now that we have the function doing what we want, we should add some comments and some error checking.</p>
<div class="sourceCode" id="cb1027"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">no_NA_sampler</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tbl</span>, <span class="va">var</span>, <span class="va">n</span><span class="op">)</span><span class="op">{</span>
  
  <span class="co"># Function for grabbing `n` samples from a variable `var` which lives in a</span>
  <span class="co"># tibble `tbl`. </span>
  
  <span class="co"># I could not figure out how to check to see if `var` actually lives in the</span>
  <span class="co"># tibble in my error checking. Also, I don't like that I need to use</span>
  <span class="co"># is_double() as the check on `n` even though I want `n` to be an integer.</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu">is_tibble</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu">is_double</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>

  <span class="va">tbl</span> <span class="op">%&gt;%</span> 
    <span class="fu">drop_na</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    
    <span class="co"># What happens if n is "too large"? That is, I need to think harder about a)</span>
    <span class="co"># whether or not I am sampling with or without replacement and b) which I</span>
    <span class="co"># should be doing.</span>
    
    <span class="fu">slice_sample</span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu">pull</span><span class="op">(</span><span class="op">{</span><span class="op">{</span><span class="va">var</span><span class="op">}</span><span class="op">}</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Do the comments in the above code seem weird? Perhaps. But they are good comments! First, there about as many lines of comments as there are lines of code. That is a good rule of thumb. Second, the comments do not simple report what the code is doing. That is redundant! <em>The code itself tells us what the code is doing.</em> The comments, instead, are a discussion of issues related to the code, to things we don’t understand, to topics which we should revisit. They are like a diary. Good programmers keep good diaries.</p>
</div>
<div id="prediction-game" class="section level2" number="11.11">
<h2>
<span class="header-section-number">11.11</span> Prediction Game<a class="anchor" aria-label="anchor" href="#prediction-game"><i class="fas fa-link"></i></a>
</h2>
<p>Let’s play a prediction game. Consider the <code>kenya</code> tibble from <strong>primer.data</strong>.</p>
<div class="sourceCode" id="cb1028"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">kenya</span></code></pre></div>
<pre><code>## # A tibble: 1,672 x 9
##    block poll_station treatment poverty distance pop_density mean_age reg_byrv13
##    &lt;chr&gt; &lt;chr&gt;        &lt;fct&gt;       &lt;dbl&gt;    &lt;dbl&gt;       &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
##  1 KWAL… 007/001      control     0.247     22.0    0.00296      39.6    0.00358
##  2 KWAL… 007/004      local + …   0.329     25.1    0.000888     43.8    0.0742 
##  3 KWAL… 007/009      local       0.263     27.8    0.00184      34.7    0.00691
##  4 KWAL… 007/011      local + …   0.429     27.2    0.000270     44.6    0.26   
##  5 KWAL… 007/017      local + …   0.341     19.3    0.000544     39.0    0.0228 
##  6 KWAL… 007/018      local       0.204     24.0    0.00798      37.1    0.00243
##  7 KWAL… 007/019      SMS         0.272     25.1    0.00167      39.2    0.00487
##  8 KWAL… 007/020      control     0.316     23.8    0.000538     36.3    0      
##  9 KWAL… 007/022      canvass     0.396     20.5    0.000216     42.9    0.00575
## 10 KWAL… 007/023      local + …   0.398     14.5    0.000148     39.8    0.0360 
## # … with 1,662 more rows, and 1 more variable: rv13 &lt;dbl&gt;</code></pre>
<p>The game is that we will pick a random value of <code>rv13</code>, which is the number of people who live in the vicinity of a polling station. You guess a number. I guess a number. The winner of the Prediction Game is the person whose guess is closest to the random value selected. Example:</p>
<div class="sourceCode" id="cb1030"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">your_guess</span> <span class="op">&lt;-</span> <span class="fl">500</span>
<span class="va">my_guess</span> <span class="op">&lt;-</span> <span class="fl">600</span>

<span class="va">sampled_value</span> <span class="op">&lt;-</span> <span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">kenya</span>, <span class="va">rv13</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> 

<span class="va">your_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">your_guess</span> <span class="op">-</span> <span class="va">sampled_value</span><span class="op">)</span>
<span class="va">my_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">my_guess</span> <span class="op">-</span> <span class="va">sampled_value</span><span class="op">)</span>

<span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">&lt;</span> <span class="va">my_error</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"You win!"</span><span class="op">)</span></code></pre></div>
<pre><code>## You win!</code></pre>
<div class="sourceCode" id="cb1032"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">&gt;</span> <span class="va">my_error</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"I win!"</span><span class="op">)</span></code></pre></div>
<p>Run this code in your R Console to try it out. It works! It is also sloppy and disorganized. <em>The first step in writing good code is to write bad code</em>.</p>
<p>We don’t want to play the Prediction Game just once. We want to play it thousands of times. Copy/pasting this code a thousand times would be stupid. Instead, we need a function. Just place the working code within a function definition, and Voila!</p>
<div class="sourceCode" id="cb1033"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prediction_game</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="va">your_guess</span> <span class="op">&lt;-</span> <span class="fl">500</span>
  <span class="va">my_guess</span> <span class="op">&lt;-</span> <span class="fl">600</span>
  
  <span class="va">sampled_value</span> <span class="op">&lt;-</span> <span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">kenya</span>, <span class="va">rv13</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> 
  
  <span class="va">your_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">your_guess</span> <span class="op">-</span> <span class="va">sampled_value</span><span class="op">)</span>
  <span class="va">my_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">my_guess</span> <span class="op">-</span> <span class="va">sampled_value</span><span class="op">)</span>
  
  <span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">&lt;</span> <span class="va">my_error</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"You win!"</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">&gt;</span> <span class="va">my_error</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"I win!"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Other than the function definition itself, there are no changes. Yet, by creating a function, we can now easily run this many times.</p>
<div class="sourceCode" id="cb1034"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fu">prediction_game</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## You win!You win!You win!</code></pre>
<pre><code>## [[1]]
## NULL
## 
## [[2]]
## NULL
## 
## [[3]]
## NULL</code></pre>
<p>The problem with this version is that we want <code>prediction_game()</code> to <em>return</em> a message about the winner. Right now, it returns nothing. It just prints the winner. Let’s change that, and also allow for guesses to be passed in as an argument, along with the tibble and variable. We can leave <code>n</code> hard coded as 1 since, by definition, the Prediction Game is an attempt to guess one number, at least for now. To do this, we need to use the <code><a href="https://rdrr.io/r/base/function.html">return()</a></code> function which, when executed, causes the function to finish and return whatever value is within the paratheses.</p>
<!-- DK: Add some code comments, especially {{var}} -->
<div class="sourceCode" id="cb1037"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prediction_game</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">guesses</span>, <span class="va">tbl</span>, <span class="va">var</span><span class="op">)</span><span class="op">{</span>
  
  <span class="co"># Check to make sure that guesses is a vector of doubles of length 2.</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu">is_double</span><span class="op">(</span><span class="va">guesses</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">guesses</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span>
  
  <span class="co"># This tells the function that the "guess" inputted first in the </span>
  <span class="co"># guesses is "your" guess, whereas the second input is "my" guess.</span>
  
  <span class="va">your_guess</span> <span class="op">&lt;-</span> <span class="va">guesses</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
  <span class="va">my_guess</span> <span class="op">&lt;-</span> <span class="va">guesses</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
  
  <span class="co"># Use the function no_NA_sampler to draw a sample from a data set</span>
  <span class="co"># of our choosing, with a {{var}} and n.</span>
  
  <span class="va">sampled_value</span> <span class="op">&lt;-</span> <span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">tbl</span>, <span class="op">{</span><span class="op">{</span><span class="va">var</span><span class="op">}</span><span class="op">}</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> 
  
  <span class="co"># Subtract the sampled value obtained from no_NA_sampler from </span>
  <span class="co"># both of our guesses. </span>
  
  <span class="va">your_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">your_guess</span> <span class="op">-</span> <span class="va">sampled_value</span><span class="op">)</span>
  <span class="va">my_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">my_guess</span> <span class="op">-</span> <span class="va">sampled_value</span><span class="op">)</span>
  
  <span class="co"># If the difference between your guess and the sampled value is </span>
  <span class="co"># less than the difference between my guess and the sampled value</span>
  <span class="co"># (meaning that your guess was closer to the truth), the function</span>
  <span class="co"># returns the message "Guess, your_guess, wins!".</span>
  
  <span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">&lt;</span> <span class="va">my_error</span><span class="op">)</span><span class="op">{</span> 
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Guess"</span>, <span class="va">your_guess</span>, <span class="st">"wins!"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="co"># If your error exceeds my error (meaning that your guess was</span>
  <span class="co"># further than the truth than mine), the function prints the </span>
  <span class="co"># message "Guess, my_guess, wins!" </span>
  
  <span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">&gt;</span> <span class="va">my_error</span><span class="op">)</span><span class="op">{</span> 
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Guess"</span>, <span class="va">my_guess</span>, <span class="st">"wins!"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="co"># If we guess the same number, and our error rates are therefore</span>
  <span class="co"># identical, we return the message "A tie!". </span>
  
  <span class="kw">if</span><span class="op">(</span><span class="va">your_error</span> <span class="op">==</span> <span class="va">my_error</span><span class="op">)</span><span class="op">{</span> 
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="st">"A tie!"</span><span class="op">)</span>
  <span class="op">}</span>

<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb1038"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fu">prediction_game</span><span class="op">(</span>guesses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">600</span><span class="op">)</span>, <span class="va">kenya</span>, <span class="va">rv13</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Guess 500 wins!" "Guess 500 wins!" "Guess 600 wins!" "Guess 500 wins!"
## [5] "Guess 500 wins!"</code></pre>
<p>In general, we will want to store the results in a tibble, which makes later analysis and plotting easier.</p>
<div class="sourceCode" id="cb1040"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu">map_chr</span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> 
                            <span class="fu">prediction_game</span><span class="op">(</span>guesses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">600</span><span class="op">)</span>,
                                            <span class="va">kenya</span>, 
                                            <span class="va">rv13</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##      ID result         
##   &lt;int&gt; &lt;chr&gt;          
## 1     1 Guess 500 wins!
## 2     2 Guess 500 wins!
## 3     3 Guess 500 wins!</code></pre>
<p>Who wins the game the most if we play 1,000 times?</p>
<div class="sourceCode" id="cb1042"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu">map_chr</span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> 
                            <span class="fu">prediction_game</span><span class="op">(</span>guesses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">600</span><span class="op">)</span>,
                                            <span class="va">kenya</span>, 
                                            <span class="va">rv13</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_bar</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-849-1.png" width="100%"></div>
<p>It is hardly surprising that 500 wins more often than 600 since the mean of <code>rv13</code> is 539.23. The mean seems like a pretty good guess! But it is not the best guess.</p>
<p>To test whether the mean or the median is a better guess, we will use our created <code>prediction_game</code> function with the guesses of 442 (the median) and 539 (the mean) and plot the results.</p>
<div class="sourceCode" id="cb1043"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu">map_chr</span><span class="op">(</span><span class="va">ID</span>, 
                          <span class="op">~</span> <span class="fu">prediction_game</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">442</span>, <span class="fl">539</span><span class="op">)</span>,
                                            <span class="va">kenya</span>,
                                            <span class="va">rv13</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_bar</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-850-1.png" width="100%"></div>
<p>The mean is not a bad prediction. But the best prediction is (surprisingly?) the median, which is 442.</p>
<div id="playing-within-a-tibble" class="section level4" number="11.11.0.1">
<h4>
<span class="header-section-number">11.11.0.1</span> Playing within a tibble<a class="anchor" aria-label="anchor" href="#playing-within-a-tibble"><i class="fas fa-link"></i></a>
</h4>
<p>In other cases, it is more convenient to play portions of the Prediction Game within a tibble. Imagine that we are trying to guess the biggest value out of 10 random samples.</p>
<div class="sourceCode" id="cb1044"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, guess_1 <span class="op">=</span> <span class="fl">800</span>, guess_2 <span class="op">=</span> <span class="fl">900</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> <span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">kenya</span>, <span class="va">rv13</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 4
##      ID guess_1 guess_2 result    
##   &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;list&gt;    
## 1     1     800     900 &lt;dbl [10]&gt;
## 2     2     800     900 &lt;dbl [10]&gt;
## 3     3     800     900 &lt;dbl [10]&gt;</code></pre>
<p>We can now manipulate the <code>result</code> column and then see which prediction did better. Using the same structure as before, we subtract our guesses from the variable we were guessing; in this case, the biggest value in 10 random samples.</p>
<div class="sourceCode" id="cb1046"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, guess_1 <span class="op">=</span> <span class="fl">800</span>, guess_2 <span class="op">=</span> <span class="fl">900</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> <span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">kenya</span>, <span class="va">rv13</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>biggest <span class="op">=</span> <span class="fu">map_dbl</span><span class="op">(</span><span class="va">result</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>error_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">guess_1</span> <span class="op">-</span> <span class="va">biggest</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>error_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">guess_2</span> <span class="op">-</span> <span class="va">biggest</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>winner <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="va">error_1</span> <span class="op">&lt;</span> <span class="va">error_2</span> <span class="op">~</span> <span class="st">"Guess one wins!"</span>,
                            <span class="va">error_1</span> <span class="op">&gt;</span> <span class="va">error_2</span> <span class="op">~</span> <span class="st">"Guess two wins!"</span>,
                            <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"A tie!"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 3 x 8
##      ID guess_1 guess_2 result     biggest error_1 error_2 winner         
##   &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;list&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;          
## 1     1     800     900 &lt;dbl [10]&gt;    1382     582     482 Guess two wins!
## 2     2     800     900 &lt;dbl [10]&gt;    2246    1446    1346 Guess two wins!
## 3     3     800     900 &lt;dbl [10]&gt;    1422     622     522 Guess two wins!</code></pre>
<p>Run the test 1,000 times.</p>
<div class="sourceCode" id="cb1048"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">tibble</span><span class="op">(</span>ID <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>, guess_1 <span class="op">=</span> <span class="fl">800</span>, guess_2 <span class="op">=</span> <span class="fl">900</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>result <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">ID</span>, <span class="op">~</span> <span class="fu">no_NA_sampler</span><span class="op">(</span><span class="va">kenya</span>, <span class="va">rv13</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>biggest <span class="op">=</span> <span class="fu">map_dbl</span><span class="op">(</span><span class="va">result</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>error_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">guess_1</span> <span class="op">-</span> <span class="va">biggest</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>error_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">guess_2</span> <span class="op">-</span> <span class="va">biggest</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>winner <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="va">error_1</span> <span class="op">&lt;</span> <span class="va">error_2</span> <span class="op">~</span> <span class="st">"Guess one wins!"</span>,
                            <span class="va">error_1</span> <span class="op">&gt;</span> <span class="va">error_2</span> <span class="op">~</span> <span class="st">"Guess two wins!"</span>,
                            <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"A tie!"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">winner</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_bar</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-853-1.png" width="100%"></div>
<p>Empirically, we see than 900 is a much better guess than 800. Instead of calling a function to be run 1,000 times, we just performed each step within each row of a tibble with 1,000 rows. Both approaches work. The best choice depends on the context of your problem.</p>
</div>
</div>
<div id="summary-12" class="section level2" number="11.12">
<h2>
<span class="header-section-number">11.12</span> Summary<a class="anchor" aria-label="anchor" href="#summary-12"><i class="fas fa-link"></i></a>
</h2>
<p><em>The first step in writing good code is to write bad code</em>.</p>
<p><em>Tilde and dot (<code><a href="https://rdrr.io/r/base/tilde.html">~</a></code> and <code>.</code>) are easy to forget.</em></p>
<p><em>The first step in building a function is not to write the function. It is to write the code which you want the function to execute.</em></p>
<div id="lists-and-list-columns" class="section level3" number="11.12.1">
<h3>
<span class="header-section-number">11.12.1</span> Lists and list-columns<a class="anchor" aria-label="anchor" href="#lists-and-list-columns"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>A list is different from an atomic vector. Atomic vectors are familiar to us: each element of the vector has one value, and thus if an atomic vector is a column in your data set, each observation gets a single value. Lists, however, can contain vectors, and other more complex objects, as elements.</li>
<li>There are various ways to create lists. The most common is to use the <code><a href="https://rdrr.io/r/base/list.html">list()</a></code> function to “wrap” some object. <code>map()</code> always returns a list.</li>
<li>We can take a list column and, by applying an anonymous function to it with <code>map()</code>, create another list column. This is similar to taking a tibble and piping it into a function, like <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>, which returns a new tibble to work with.</li>
<li>You can also use <code>map_*</code> functions to take a list column as an input and return an atomic vector – a column with a single value per observation – as an output.</li>
</ul>
<p><em>If a function returns multiple values as a vector, you must use <code><a href="https://rdrr.io/r/base/list.html">list()</a></code> as a wrapper if you want to create a list-column.</em></p>
</div>
<div id="writing-functions" class="section level3" number="11.12.2">
<h3>
<span class="header-section-number">11.12.2</span> Writing functions<a class="anchor" aria-label="anchor" href="#writing-functions"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Optimize usefulness by adding more formal arguments when needed. A function that only gives an option for <code>n</code> may not be as helpful as a function that allows us to enter options for a data set, variable, and n value.</li>
<li>Give your arguments sensible names.<br>
</li>
<li>By default, a function returns the result of the last line of the body. Use <code><a href="https://rdrr.io/r/base/function.html">return()</a></code> to override this default.</li>
<li>When starting a function, remember that smaller steps are easier than trying to build everything in one motion. In general: start by writing the body, test the body in a basic function, and then add formal arguments.<br>
</li>
<li>Use double curly braces around <code>var</code>s, since R does not know how to interpret variable names when they are passed in an argument. The double curly braces tell R that <code>var</code> is a variable in a tibble.</li>
</ul>
</div>
<div id="distributions-1" class="section level3" number="11.12.3">
<h3>
<span class="header-section-number">11.12.3</span> Distributions<a class="anchor" aria-label="anchor" href="#distributions-1"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>The word “distribution” can mean two things. First, it is an object — a mathematical formula, an imaginary urn — from which you can draw values. Second, it is a list of such values.<br>
</li>
<li>The two most important aspects of a distribution are its <em>center</em> and its <em>variability</em>.</li>
<li>The median is often a more stable measure of the center than the mean. The mad (scaled median absolute deviation) is often a more stable measure of variation than the standard deviation.</li>
<li>Outliers cause a lack a stability. In a distribution without outliers, the mean/median and mad/sd are so close in value that it does not matter much which ones you use.</li>
</ul>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="tools.html">Tools</a></div>
<div class="next"><a href="maps.html">Maps</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#functions">Functions</a></li>
<li><a class="nav-link" href="#introduction-1"><span class="header-section-number">11.7</span> Introduction</a></li>
<li><a class="nav-link" href="#list-columns-and-map-functions-1"><span class="header-section-number">11.8</span> List-columns and map functions</a></li>
<li>
<a class="nav-link" href="#custom-functions"><span class="header-section-number">11.9</span> Custom Functions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#creating-your-own-functions"><span class="header-section-number">11.9.1</span> Creating your own functions</a></li>
<li><a class="nav-link" href="#anonymous-functions-with-map_-functions"><span class="header-section-number">11.9.2</span> Anonymous functions with map_* functions</a></li>
<li><a class="nav-link" href="#skateboard-perfectly-formed-rear-view-mirror"><span class="header-section-number">11.9.3</span> Skateboard &gt;&gt; perfectly formed rear-view mirror</a></li>
</ul>
</li>
<li><a class="nav-link" href="#no_na_sampler"><span class="header-section-number">11.10</span> no_NA_sampler()</a></li>
<li><a class="nav-link" href="#prediction-game"><span class="header-section-number">11.11</span> Prediction Game</a></li>
<li>
<a class="nav-link" href="#summary-12"><span class="header-section-number">11.12</span> Summary</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#lists-and-list-columns"><span class="header-section-number">11.12.1</span> Lists and list-columns</a></li>
<li><a class="nav-link" href="#writing-functions"><span class="header-section-number">11.12.2</span> Writing functions</a></li>
<li><a class="nav-link" href="#distributions-1"><span class="header-section-number">11.12.3</span> Distributions</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/PPBDS/primer/blob/master/functions.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/PPBDS/primer/edit/master/functions.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Preceptor’s Primer for Bayesian Data Science</strong>" was written by David Kane. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
