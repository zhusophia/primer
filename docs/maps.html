<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Maps | Preceptor’s Primer for Bayesian Data Science</title>
<meta name="author" content="David Kane">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.8/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.5.1/tabs.js"></script><script src="libs/bs3compat-0.2.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><script src="libs/plotly-binding-4.9.3/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css-1.57.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-1.57.1/plotly-latest.min.js"></script><script src="libs/rglWebGL-binding-0.106.8/rglWebGL.js"></script><link href="libs/rglwidgetClass-0.106.8/rgl.css" rel="stylesheet">
<script src="libs/rglwidgetClass-0.106.8/rglClass.min.js"></script><script src="libs/CanvasMatrix4-0.106.8/CanvasMatrix.min.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Preceptor’s Primer for Bayesian Data Science</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preamble.html">Preamble</a></li>
<li><a class="" href="getting-started.html">Getting Started</a></li>
<li><a class="" href="visualization.html"><span class="header-section-number">1</span> Visualization</a></li>
<li><a class="" href="wrangling.html"><span class="header-section-number">2</span> Wrangling</a></li>
<li><a class="" href="data.html"><span class="header-section-number">3</span> Data</a></li>
<li><a class="" href="rubin-causal-model.html"><span class="header-section-number">4</span> Rubin Causal Model</a></li>
<li><a class="" href="probability.html"><span class="header-section-number">5</span> Probability</a></li>
<li><a class="" href="one-parameter.html"><span class="header-section-number">6</span> One Parameter</a></li>
<li><a class="" href="two-parameters.html"><span class="header-section-number">7</span> Two Parameters</a></li>
<li><a class="" href="three-parameters.html"><span class="header-section-number">8</span> Three Parameters</a></li>
<li><a class="" href="four-parameters.html"><span class="header-section-number">9</span> Four Parameters</a></li>
<li><a class="" href="five-parameters.html"><span class="header-section-number">10</span> Five Parameters</a></li>
<li><a class="" href="n-parameters.html"><span class="header-section-number">11</span> N Parameters</a></li>
<li><a class="" href="tools.html">Tools</a></li>
<li><a class="" href="functions.html">Functions</a></li>
<li><a class="active" href="maps.html">Maps</a></li>
<li><a class="" href="ipums.html">IPUMS</a></li>
<li><a class="" href="animation.html">Animation</a></li>
<li><a class="" href="set-up-for-working-on-the-primer.html">Set Up for Working on The Primer</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/PPBDS/primer">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="maps" class="section level1 unnumbered">
<h1>Maps<a class="anchor" aria-label="anchor" href="#maps"><i class="fas fa-link"></i></a>
</h1>
<!-- Add something about street maps? http://joshuamccrain.com/tutorials/maps/streets_tutorial.html Or Map Box, which looks very cool. -->
<!-- Should we have the code run live or just save the data and pretend to run it live? Not sure! I am actually having trouble getting it to compile live. It seems like, when knitting, it does not have access to my API key. Why would that be? Running live takes a bunch of time. But the data is awfully large to store, much too large to put in Github, thereby preventing automated builds/testing. -->
<!-- Plan: No live downloads. Store data needed, perhaps even only the summary data. -->
<!-- Shorten beginning by just doing one download and then explaining all the parts? -->
<!-- Use summary.var from the very beginning? Related: Is this a teaching chapter (show the same thing in a bunch of ways) or a summary chapter (show one cool way and explain all the parts)? -->
<p>In order to make maps, we first need some data.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;This section remixes some material from &lt;a href="https://github.com/andrewbtran/NICAR-2019-mapping" class="uri"&gt;https://github.com/andrewbtran/NICAR-2019-mapping&lt;/a&gt; by Andrew Tran.&lt;/p&gt;'><sup>2</sup></a></p>
<div id="tidycensus" class="section level2 unnumbered">
<h2>Tidycensus<a class="anchor" aria-label="anchor" href="#tidycensus"><i class="fas fa-link"></i></a>
</h2>
<p>We need the <strong>tidyverse</strong> and <strong>tidycensus</strong> packages.</p>
<div class="sourceCode" id="cb1040"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/walkerke/tidycensus">tidycensus</a></span><span class="op">)</span></code></pre></div>
<p>Note that to use <strong>tidycensus</strong>, you’ll need a Census API key. You can request a key <a href="https://api.census.gov/data/key_signup.html">here</a>. Once you have a key, use the <code><a href="https://rdrr.io/pkg/tidycensus/man/census_api_key.html">census_api_key()</a></code> function:</p>
<div class="sourceCode" id="cb1041"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/census_api_key.html">census_api_key</a></span><span class="op">(</span><span class="st">"API KEY"</span><span class="op">)</span>  <span class="co"># You must replace API KEY with your actual key.</span></code></pre></div>
<p>If you run the <code><a href="https://rdrr.io/pkg/tidycensus/man/census_api_key.html">census_api_key()</a></code> function with the option <code>install = TRUE</code>, it will save your API key in your <code>.Renviron</code> so you don’t have to run <code><a href="https://rdrr.io/pkg/tidycensus/man/census_api_key.html">census_api_key()</a></code> every time you want to get data from the Census. However, you should only do this once. You can examine/edit your <code>.Renviron</code> file directly with <code><a href="https://usethis.r-lib.org/reference/edit.html">usethis::edit_r_environ()</a></code>.</p>
<p>There are two main sources we will be getting data from: the <strong>American Community Survey (ACS)</strong> and the <strong>Decennial Census</strong>. Both sources can be seen at <a href="https://data.census.gov">data.census.gov</a>.</p>
<p>When you click on <a href="https://data.census.gov">data.census.gov</a>., you will be brought to a homepage with a search bar. You can then type the topic of interest.</p>
<div class="inline-figure"><img src="maps/images/searchbar.png" width="100%"></div>
<p>For example, you could search for “resident population,” and it will bring you to a page of various sources. Under each bolded title, you will see <em>Survey/Program</em> , which tells you the data source. We will only be focusing on the ACS and Decennial Census sources.</p>
<div class="inline-figure"><img src="maps/images/source-arrow.png" width="100%"></div>
<p>To get data from the Decennial Census, use <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code>. The key arguments here are <code>geography</code>, <code>variables</code>, and <code>year</code>.</p>
<ul>
<li><p><code>geography</code> determines the unit of analysis (i.e. the “geography” of your data. For example, we could use “state,” but there are many other <a href="https://walkerke.github.io/tidycensus/articles/basic-usage.html#geography-in-tidycensus">geographies</a> you could use, such as “us” for the entire country, “county” for counties, and so on.</p></li>
<li><p><code>variables</code> selects which Census variables you want. To know which variable you are dealing with, you have two options.</p></li>
</ul>
<p><strong>The first way:</strong> look at the data.census.gov website. In addition to <em>Survey/Program</em>, you will also see the bolded term <em>Tables</em>. It will tell you the name of the variable. However, the variable names are a little tricky. For example, the variable name for population below is “B01003.” <strong>Make sure that the ID is a 6 digit string. If it isn’t that is a Table ID and does not work.</strong></p>
<div class="inline-figure"><img src="maps/images/table.png" width="100%"></div>
<p>This way is good if you already know the exact name of the variable that you want, but it’s not the most useful for finding a general description because it doesn’t provide any context for what the variable is. It also doesn’t work for most complex variables since they’re pretty hard to find.</p>
<p><strong>The second way</strong>: look at the census API documentation for information about the variables. By visiting <a href="https://api.census.gov/data/2010/dec/sf1/variables.html">the API documentation</a>, you can see the variables that the Census officially uses.</p>
<p>This allows you to see all of the variables that are used in the Census, and by pressing “Ctrl+F” or “Cmd+F” you can find the variables that have a certain word within them. However, you can’t do advanced search operations like multiple searches and you have to do it manually.</p>
<p><strong>The third way</strong>: use the <code><a href="https://rdrr.io/pkg/tidycensus/man/load_variables.html">load_variables()</a></code> function in <strong>tidycensus</strong> to generate a tibble of variable names (described <a href="https://walkerke.github.io/tidycensus/articles/basic-usage.html#searching-for-variables">here</a>). The two key arguments to <code><a href="https://rdrr.io/pkg/tidycensus/man/load_variables.html">load_variables()</a></code> are the <code>year</code> and <code>dataset</code>. For the year, you must use the year or end-year of the Decennial Census. For the <code>dataset</code> argument, you can either use “sf1” and “sf3.”</p>
<p>This way is the best for finding variables quickly within R, as you can use <strong>dbplyr</strong> commands like <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> to find the variables you want. That lets you do advanced search commands and quickly find the variables you want.</p>
<ul>
<li>
<code>year</code> is the last argument to <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code> that we will be using. <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code> can obtain data from the 1990, 2000, and 2010 Census. You can find the year for your variable under <em>Years</em> .</li>
</ul>
<div class="inline-figure"><img src="maps/images/years.png" width="100%"></div>
<p>Now that we have a better understanding the arguments to the function <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code>, let’s practice using it!</p>
<p>Consider the following code.</p>
<div class="sourceCode" id="cb1042"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial</a></span><span class="op">(</span>geography <span class="op">=</span> <span class="st">"state"</span>,
                     variables <span class="op">=</span> <span class="st">"P001001"</span>,
                     year <span class="op">=</span> <span class="fl">2010</span><span class="op">)</span>

<span class="fu">glimpse</span><span class="op">(</span><span class="va">pop</span><span class="op">)</span></code></pre></div>
<pre><code>## Rows: 52
## Columns: 4
## $ GEOID    &lt;chr&gt; "01", "02", "04", "05", "06", "22", "21", "08", "09", "10", "…
## $ NAME     &lt;chr&gt; "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Lo…
## $ variable &lt;chr&gt; "P001001", "P001001", "P001001", "P001001", "P001001", "P0010…
## $ value    &lt;dbl&gt; 4.8e+06, 7.1e+05, 6.4e+06, 2.9e+06, 3.7e+07, 4.5e+06, 4.3e+06…</code></pre>
<p>The output is a tibble with four columns:</p>
<ul>
<li>
<code>GEOID</code> is part of the FIPS code, which is short for Federal Information Processing Standard. It’s a standardized way to identify states, counties, census tracts, etc. In this instance it’s only two characters wide. The more specific you get into the Census boundaries, the longer the code becomes.</li>
<li>
<code>NAME</code> is the generic name <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code> gives to the unit you selected with <code>geography</code>; here, they are state names. Note that there are 52 observations; the “state” geography includes the District of Columbia and Puerto Rico, along with the 50 states.</li>
<li>
<code>variable</code> is the name of the variable you selected.</li>
<li>
<code>value</code> is the value of the variable you selected (here, population).</li>
</ul>
<p>By default, <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code> will stack all the variables on top of each other if you select more than one, identifying them with the <code>variable</code> column. So let’s say that you wanted to know the proportion of the population of each state that lives in rural areas. You would select two variables (total population and rural population) and would receive a tibble with 104 observations, with each state appearing once per variable. This may not be the most helpful way to receive the data, depending on your purposes. (When faceting, you may want the data in a long format like this, as we’ll see below.) You can request the data in wide format instead by using the option <code>output = "wide"</code>.</p>
<div class="sourceCode" id="cb1044"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial</a></span><span class="op">(</span>geography <span class="op">=</span> <span class="st">"state"</span>,
                       variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"P001001"</span>, <span class="st">"P002005"</span><span class="op">)</span>,
                       year <span class="op">=</span> <span class="fl">2010</span>,
                       output <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span>
<span class="fu">glimpse</span><span class="op">(</span><span class="va">rural</span><span class="op">)</span></code></pre></div>
<pre><code>## Rows: 52
## Columns: 4
## $ GEOID   &lt;chr&gt; "01", "02", "04", "05", "06", "22", "21", "08", "09", "10", "1…
## $ NAME    &lt;chr&gt; "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Lou…
## $ P001001 &lt;dbl&gt; 4.8e+06, 7.1e+05, 6.4e+06, 2.9e+06, 3.7e+07, 4.5e+06, 4.3e+06,…
## $ P002005 &lt;dbl&gt; 1957932, 241338, 651358, 1278329, 1880350, 1215567, 1806024, 6…</code></pre>
<p>Here, we created a tibble with states in the rows and total population (“P001001”) and rural population (“P002005”) in the columns. To plot the proportion of each state’s population that lives in rural areas is now a simple application of <strong>tidyverse</strong> functions we know and love. First, let’s create a variable for rural population proportion and order the states by that variable:</p>
<div class="sourceCode" id="cb1046"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop_rural <span class="op">=</span> <span class="va">P002005</span><span class="op">/</span><span class="va">P001001</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">prop_rural</span>, y <span class="op">=</span> <span class="fu">fct_reorder</span><span class="op">(</span><span class="va">NAME</span>, <span class="va">prop_rural</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Rural Population in US States in 2010"</span>,
         subtitle <span class="op">=</span> <span class="st">"Maine and Vermont are the most rural states"</span>,
         caption <span class="op">=</span> <span class="st">"Source: US Census"</span>,
         x <span class="op">=</span> <span class="st">"Rural Population Proportion"</span>,
         y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-861-1.png" width="100%"></div>
<p>Maine and Vermont are very rural while Washington D.C. is entirely urban. What if we wanted a sense of how the proportion of rural residents varied geographically? We need a map!</p>
</div>
<div id="conceptual-introduction-to-mapping" class="section level2 unnumbered">
<h2>Conceptual introduction to mapping<a class="anchor" aria-label="anchor" href="#conceptual-introduction-to-mapping"><i class="fas fa-link"></i></a>
</h2>
<p>There are two underlying important pieces of information for spatial data: the coordinates of the object and how the coordinates relate to a physical location on Earth, which is also known as a coordinate reference system or <strong>CRS</strong>.</p>
<p>The coordinates are familiar from geography. A CRS uses a three-dimensional model of the earth to define specific locations on the surface of the grid. An object can be defined in relation to longitude (East/West) and latitude (North/South).</p>
<p>Where this gets complicated is when attempting to create a projection. A projection is a translation of the three-dimensional grid onto a two-dimensional plane. The animation below demonstrates this process.</p>
<div class="inline-figure"><img src="other/images/projection_tween.gif" width="100%"></div>
<p>Thus, the CRS determines how a geometric object will look when displayed on your two-dimensional screen. We rarely need to specify a CRS when working with <strong>tidycensus</strong>, but it is good to know about the concept if you ever work with other spatial data.</p>
<div id="vector-versus-spatial-data" class="section level3 unnumbered">
<h3>Vector versus spatial data<a class="anchor" aria-label="anchor" href="#vector-versus-spatial-data"><i class="fas fa-link"></i></a>
</h3>
<p>Spatial data with a defined CRS can either be vector or raster data. Vector data is based on points that can be connected to form lines and polygons. It is located within a <em>coordinate reference system.</em> An example is a road map.</p>
<p>Raster data, however, are values within a <em>grid system,</em> such as satellite imagery. In this <em>Primer</em>, we will only be dealing with vector data, which is the format in which we get data from the <strong>tidycensus</strong> package.</p>
</div>
<div id="sf-vs-sp" class="section level3 unnumbered">
<h3>
<strong>sf</strong> vs <strong>sp</strong><a class="anchor" aria-label="anchor" href="#sf-vs-sp"><i class="fas fa-link"></i></a>
</h3>
<p>An older package, <strong>sp</strong>, lets a user handle both vector and raster data. This book will focus on vector data and the <strong>sf</strong> package. The main differences between the <strong>sp</strong> and <strong>sf</strong> packages are how they store CRS information. While <strong>sp</strong> uses spatial sub classes, <strong>sf</strong> stores data in data frames, allowing it to interact with <strong>dplyr</strong> methods we’ve learned so far.</p>
</div>
<div id="shapefiles" class="section level3 unnumbered">
<h3>Shapefiles<a class="anchor" aria-label="anchor" href="#shapefiles"><i class="fas fa-link"></i></a>
</h3>
<p>R can handle importing different kinds of file formats for spatial data, including KML and geojson. We’ll focus on shapefiles, which were created by Esri in the 1990s. Though we refer to a “shapefile” in the singular, it’s actually a collection of at least three basic files:</p>
<ul>
<li>.shp - lists shape and vertices</li>
<li>.shx - has index with offsets</li>
<li>.dbf - relationship file between geometry and attributes (data)</li>
</ul>
<p>All files must be present in the directory and named the same (except for the file extension) to import correctly. Thankfully, <strong>tidycensus</strong> will grab the geometric information from the Census shapefile for you.</p>
</div>
</div>
<div id="mapping-with-tidycensus-and-geom_sf" class="section level2 unnumbered">
<h2>Mapping with <strong>tidycensus</strong> and <code>geom_sf()</code><a class="anchor" aria-label="anchor" href="#mapping-with-tidycensus-and-geom_sf"><i class="fas fa-link"></i></a>
</h2>
<p>In order to start mapping in R, we need to get a little more data from the <strong>tidycensus</strong> package. In particular, we need to set <code>geometry = TRUE</code>.</p>
<div class="sourceCode" id="cb1047"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial</a></span><span class="op">(</span>geography <span class="op">=</span> <span class="st">"state"</span>,
                       variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"P001001"</span>, <span class="st">"P002005"</span><span class="op">)</span>,
                       year <span class="op">=</span> <span class="fl">2010</span>,
                       output <span class="op">=</span> <span class="st">"wide"</span>,
                       geometry <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> 

<span class="fu">glimpse</span><span class="op">(</span><span class="va">rural</span><span class="op">)</span></code></pre></div>
<pre><code>## Rows: 52
## Columns: 5
## $ GEOID    &lt;chr&gt; "01", "02", "04", "05", "06", "22", "21", "08", "09", "10", "…
## $ NAME     &lt;chr&gt; "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Lo…
## $ P001001  &lt;dbl&gt; 4.8e+06, 7.1e+05, 6.4e+06, 2.9e+06, 3.7e+07, 4.5e+06, 4.3e+06…
## $ P002005  &lt;dbl&gt; 1957932, 241338, 651358, 1278329, 1880350, 1215567, 1806024, …
## $ geometry &lt;MULTIPOLYGON [°]&gt; MULTIPOLYGON (((-85 31, -85..., MULTIPOLYGON (((…</code></pre>
<p>This is similar to the tibble we created before. However, there are two key differences. First, we now have this funky “multipolygon” column called <code>geometry</code>. This is a list column containing all the information <code>ggplot()</code> needs to create a map. Second, rural is no longer a tibble.</p>
<div class="sourceCode" id="cb1049"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">rural</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "sf"         "tbl_df"     "tbl"        "data.frame"</code></pre>
<p><code><a href="https://rdrr.io/r/base/class.html">class()</a></code> is a function which tells us the, uh, “class” of an object. <code>rural</code> is of class “sf,” which is a special kind of tibble which includes information for plotting. For this reason, <strong>you should never use <code><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble()</a></code> on an object of class “sf” since doing so strips the object of the key attributes it needs to make plotting easier.</strong></p>
<p>In order to create a map using <code>ggplot()</code>, we need a new geom: <code>geom_sf()</code>. This works much like the geoms we have seen before, such as <code>geom_point()</code> and <code>geom_line()</code>, except with spatial data. In particular, it is designed to work with objects of class “sf.” Example:</p>
<div class="sourceCode" id="cb1051"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-866-1.png" width="100%"></div>
<p>We have the boundaries of each state, including Alaska and Hawaii. But there are some problems. <strong>ggplot2</strong> is doing its best to fit everything on one image, which is taxing on the system. We can’t see any particular state very well, because the map is zoomed far out. Also, there are no colors because we didn’t fill it with our data.</p>
<p>So, let’s create a new map with <code>geom_sf()</code> and fill it with <code>prop_rural</code>. And we’ll filter out Alaska, Hawaii, and Puerto Rico for now.</p>
<div class="sourceCode" id="cb1052"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="va">NAME</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Alaska"</span>, <span class="st">"Hawaii"</span>, <span class="st">"Puerto Rico"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">P002005</span> <span class="op">/</span> <span class="va">P001001</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-867-1.png" width="100%"></div>
<p>Now we have something usable! This already has a lot of what we’d want from a map—most notably, the states are shaded based on our variable of interest, helping us to see some patterns in the data. But it could use a bit of a makeover, which we’ll give it in the next section.</p>
<div id="making-maps-pretty" class="section level3 unnumbered">
<h3>Making maps pretty<a class="anchor" aria-label="anchor" href="#making-maps-pretty"><i class="fas fa-link"></i></a>
</h3>
<p>There are a few ways we can aesthetically improve this map:</p>
<ul>
<li>Make the fill colors easier to distinguish</li>
<li>Make it so that darker colors map onto higher values of <code>prop_rural</code>
</li>
<li>Remove the gray background</li>
<li>Give the legend an informative title and add a title and caption</li>
</ul>
<p>A great function for providing the fill colors for maps is <code>scale_fill_viridis_c()</code>. This has a few different color palettes that can be selected with the <code>option</code> argument, all of which are easily distinguishable both when displayed in black and white and for people with common forms of colorblindness. You can also reverse the default order of the colors with the <code>direction = -1</code> option. This function is for continuous variables such as <code>prop_rural</code>; if you have a discrete variable, you can use the analogous <code>scale_fill_viridis_d()</code>.</p>
<p>We’ll also use <code>theme_void()</code>, a great theme for maps that gets rid of the gray background. Finally, we’ll use <code>labs()</code> to give the legend the title “Percent Rural” (and multiply the values of the variable by 100) and add an overall title and caption.</p>
<div class="sourceCode" id="cb1053"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="va">NAME</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Alaska"</span>, <span class="st">"Hawaii"</span>, <span class="st">"Puerto Rico"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">P002005</span> <span class="op">/</span> <span class="va">P001001</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span>,
                         direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Rural geography of the United States"</span>,
         caption <span class="op">=</span> <span class="st">"Source: Census 2010"</span>,
         fill <span class="op">=</span> <span class="st">"Percent Rural"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-868-1.png" width="100%"></div>
<p>With this map, it is clear that the more rural states are concentrated in the Great Plains, the South, and parts of New England, while the (South)west and Northeast are less rural.</p>
</div>
<div id="adding-back-alaska-and-hawaii" class="section level3 unnumbered">
<h3>Adding back Alaska and Hawaii<a class="anchor" aria-label="anchor" href="#adding-back-alaska-and-hawaii"><i class="fas fa-link"></i></a>
</h3>
<p>But what about Alaska and Hawaii? If you want to display those on your map without having to zoom out, you can take advantage of an argument in <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code>, <code>shift_geo = TRUE</code>:</p>
<div class="sourceCode" id="cb1054"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural_shifted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial</a></span><span class="op">(</span>geography <span class="op">=</span> <span class="st">"state"</span>,
                               variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"P001001"</span>, <span class="st">"P002005"</span><span class="op">)</span>,
                               year <span class="op">=</span> <span class="fl">2010</span>,
                               output <span class="op">=</span> <span class="st">"wide"</span>,
                               geometry <span class="op">=</span> <span class="cn">TRUE</span>,
                               shift_geo <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>state <span class="op">=</span> <span class="va">NAME</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop_rural <span class="op">=</span> <span class="va">P002005</span><span class="op">/</span><span class="va">P001001</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb1055"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural_shifted</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">prop_rural</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span>,
                       direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Rural geography of the United States"</span>,
       caption <span class="op">=</span> <span class="st">"Source: Census 2010"</span>,
       fill <span class="op">=</span> <span class="st">"Percent Rural"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-871-1.png" width="100%"></div>
<p>Now, Alaska and Hawaii can be displayed near the lower 48 states. This option removes Puerto Rico from your tibble altogether, so it is not a good choice if you want to show data from Puerto Rico.</p>
</div>
</div>
<div id="faceting-maps" class="section level2 unnumbered">
<h2>Faceting maps<a class="anchor" aria-label="anchor" href="#faceting-maps"><i class="fas fa-link"></i></a>
</h2>
<p>A powerful tool in <strong>ggplot2</strong> to use with maps is faceting. Let’s grab data from the ACS on the population in Harris County, Texas census tracts by race:</p>
<div class="sourceCode" id="cb1056"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">racevars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>White <span class="op">=</span> <span class="st">"B02001_002"</span>, 
              Black <span class="op">=</span> <span class="st">"B02001_003"</span>, 
              Asian <span class="op">=</span> <span class="st">"B02001_005"</span>,
              Hispanic <span class="op">=</span> <span class="st">"B03003_003"</span><span class="op">)</span>
<span class="va">harris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_acs.html">get_acs</a></span><span class="op">(</span>geography <span class="op">=</span> <span class="st">"tract"</span>,
                  variables <span class="op">=</span> <span class="va">racevars</span>, 
                  year <span class="op">=</span> <span class="fl">2018</span>,
                  state <span class="op">=</span> <span class="st">"TX"</span>,
                  county <span class="op">=</span> <span class="st">"Harris County"</span>,
                  geometry <span class="op">=</span> <span class="cn">TRUE</span>,
                  summary_var <span class="op">=</span> <span class="st">"B02001_001"</span><span class="op">)</span> </code></pre></div>
<p>This code is very similar to what we’ve used before, except here we are retrieving the data from the American Community Survey using <code><a href="https://rdrr.io/pkg/tidycensus/man/get_acs.html">get_acs()</a></code> instead of from the decennial census. Some new features worth pointing out:</p>
<ul>
<li>The <code>year</code> for <code><a href="https://rdrr.io/pkg/tidycensus/man/get_acs.html">get_acs()</a></code> is the last year of a five year sample. Thus, our data will be from 2014–2018. You can choose <code>year</code>s from 2009–2018.</li>
<li>Since our geography is “tract,” we are further specifying the <code>state</code> and <code>county</code>.</li>
<li>We are obtaining the data in a long format, which makes faceting easier.</li>
<li>We added a <code>summary_var</code>, “B02001_001,” which is the total population. As we’ll see, this appears as a separate column, which is helpful to us. (As an exercise, try going back to the code that created <code>rural</code> and see how you would do that in a long format with <code>summary_var</code>.)</li>
</ul>
<p>Let’s take a look at <code>harris</code>:</p>
<div class="sourceCode" id="cb1057"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">glimpse</span><span class="op">(</span><span class="va">harris</span><span class="op">)</span></code></pre></div>
<pre><code>## Rows: 3,144
## Columns: 8
## $ GEOID       &lt;chr&gt; "48201100000", "48201100000", "48201100000", "48201100000"…
## $ NAME        &lt;chr&gt; "Census Tract 1000, Harris County, Texas", "Census Tract 1…
## $ variable    &lt;chr&gt; "White", "Black", "Asian", "Hispanic", "White", "Black", "…
## $ estimate    &lt;dbl&gt; 3426, 1045, 230, 892, 2936, 3591, 7, 2119, 2973, 885, 0, 3…
## $ moe         &lt;dbl&gt; 390, 308, 106, 241, 1358, 2196, 14, 1013, 430, 242, 13, 47…
## $ summary_est &lt;dbl&gt; 5063, 5063, 5063, 5063, 6820, 6820, 6820, 6820, 4403, 4403…
## $ summary_moe &lt;dbl&gt; 478, 478, 478, 478, 3685, 3685, 3685, 3685, 502, 502, 502,…
## $ geometry    &lt;MULTIPOLYGON [°]&gt; MULTIPOLYGON (((-95 30, -95..., MULTIPOLYGON …</code></pre>
<p>These are similar to what we’ve seen before. Note that we now have <code>moe</code> and <code>summary_moe</code> columns, which stand for “margin of error.” This is because, unlike the decennial census, the ACS is a survey and thus the values we get are estimates of the true value.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Even the decennial census, of course, is an estimate, given the possibility of nonresponse and other errors, but it is closer to the true value than a survey.&lt;/p&gt;"><sup>3</sup></a></p>
<div id="transforming-and-mapping-the-data" class="section level3 unnumbered">
<h3>Transforming and mapping the data<a class="anchor" aria-label="anchor" href="#transforming-and-mapping-the-data"><i class="fas fa-link"></i></a>
</h3>
<p>Now we can use <code>facet_wrap()</code> to look at our race variables side-by-side:</p>
<div class="sourceCode" id="cb1059"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">harris</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Percent <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">estimate</span> <span class="op">/</span> <span class="va">summary_est</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Percent</span>, color <span class="op">=</span> <span class="va">Percent</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">variable</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_viridis_c</span><span class="op">(</span>direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Racial geography of Harris County, Texas"</span>,
       caption <span class="op">=</span> <span class="st">"Source: American Community Survey 2014-2018"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-875-1.png" width="100%"></div>
<p>Note how easy it was to create the percentages using <code>summary_est</code>. We also used <code>color = Percent</code> and <code>scale_color_viridis_c()</code> to avoid having annoying borders around each of the census tracts. Otherwise, this doesn’t differ much from our code before, yet it is much easier to make comparisons across variables. Faceting is a powerful tool to use with maps.</p>
</div>
</div>
<div id="working-with-big-data" class="section level2 unnumbered">
<h2>Working with big data<a class="anchor" aria-label="anchor" href="#working-with-big-data"><i class="fas fa-link"></i></a>
</h2>
<p>Instead of a census tract map for just one city, let’s do a “big data” project involving every census track in the country, plotting the percentage of people who are two or more races.</p>
<p>Start by finding the correct variable in the American Community Survey by using the <code><a href="https://rdrr.io/pkg/tidycensus/man/load_variables.html">load_variables()</a></code> function. This function takes two required arguments: the year of the Census or endyear of the ACS sample, and the specific dataset. Example:</p>
<div class="sourceCode" id="cb1060"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acs2018</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/load_variables.html">load_variables</a></span><span class="op">(</span><span class="fl">2018</span>, <span class="st">"acs5"</span><span class="op">)</span>

<span class="va">acs2018</span></code></pre></div>
<p>In the 2018 ACS, the variable we’re looking for is called <code>"B02001_008"</code>. We also need total population (<code>"B02001_001"</code>) to calculate a percentage. There are a total of 74,134 census tracts in the US. Note that the <code>state.name</code> vector included base R, includes the names of every state in the US.</p>
<p>In this case, we use <code>state.name</code> to make <code>continental</code>, a vector of every state in the US other than Alaska and Hawaii.</p>
<div class="sourceCode" id="cb1061"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">continental</span> <span class="op">&lt;-</span> <span class="va">state.name</span><span class="op">[</span><span class="op">!</span> <span class="va">state.name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Alaska"</span>, <span class="st">"Hawaii"</span><span class="op">)</span><span class="op">]</span>

<span class="va">races</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_acs.html">get_acs</a></span><span class="op">(</span>geography <span class="op">=</span> <span class="st">"tract"</span>,
                 state <span class="op">=</span> <span class="va">continental</span>,
                 variables <span class="op">=</span> <span class="st">"B02001_008"</span>, 
                 year <span class="op">=</span> <span class="fl">2018</span>,
                 summary_var <span class="op">=</span> <span class="st">"B02001_001"</span>,
                 geometry <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">races</span></code></pre></div>
<pre><code>## Simple feature collection with 72359 features and 7 fields (with 196 geometries empty)
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -120 ymin: 25 xmax: -67 ymax: 49
## Geodetic CRS:  NAD83
## # A tibble: 72,359 x 8
##    GEOID    NAME                 variable estimate   moe summary_est summary_moe
##    &lt;chr&gt;    &lt;chr&gt;                &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
##  1 0111703… Census Tract 303.17… B02001_…      223   117        4100         301
##  2 0111901… Census Tract 115, S… B02001_…       11    20        4380         441
##  3 0112101… Census Tract 109, T… B02001_…       55    69        3102         389
##  4 0112501… Census Tract 101.02… B02001_…       16    27        3026         348
##  5 0108900… Census Tract 7.01, … B02001_…       90    65        2617         389
##  6 0108900… Census Tract 22, Ma… B02001_…       76    48        1921         197
##  7 0108900… Census Tract 30, Ma… B02001_…       27    35        2589         345
##  8 0109503… Census Tract 309.02… B02001_…      122    86        4504         379
##  9 0109700… Census Tract 4.01, … B02001_…        0    12        1068         177
## 10 0109700… Census Tract 4.02, … B02001_…        0    12         833         113
## # … with 72,349 more rows, and 1 more variable: geometry &lt;MULTIPOLYGON [°]&gt;</code></pre>
<p>We set <code>size</code> to 0.003 to create thin outlines around our census tracts, any larger and they would make it hard to see our tracts. We also use the <code>inferno</code> option of <code>scale_fill_viridis()</code> for a different aesthetic from our previous plots. We add <code>theme_void()</code> and some <code>labs()</code> .</p>
<div class="sourceCode" id="cb1063"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">races</span>  <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Percent <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">estimate</span> <span class="op">/</span> <span class="va">summary_est</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Percent</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.003</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, option <span class="op">=</span> <span class="st">"inferno"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Percent of People Who are Two or More Races by Census Tract"</span>,
       caption <span class="op">=</span> <span class="st">"Source: American Community Survey 2014-2018"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-879-1.png" width="100%"></div>
</div>
<div id="pums" class="section level2 unnumbered">
<h2>PUMS<a class="anchor" aria-label="anchor" href="#pums"><i class="fas fa-link"></i></a>
</h2>
<p>Census microdata, often referred to as ‘Public Use Microdata Samples’ or PUMS, contains advanced census data on individual people. PUMS contains data for roughly 1% of the US population. To access PUMS, use the <code>get_PUMS()</code> function, which works in a very similar way to <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code> or <code><a href="https://rdrr.io/pkg/tidycensus/man/get_acs.html">get_acs()</a></code>.</p>
<p>If you’re having trouble finding which PUMS variables represents what, the <strong>tidycensus</strong> dataset <code>pums_variables</code> can be helpful.</p>
<div class="sourceCode" id="cb1064"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">glimpse</span><span class="op">(</span><span class="va">pums_variables</span><span class="op">)</span></code></pre></div>
<pre><code>## Rows: 31,759
## Columns: 12
## $ survey     &lt;chr&gt; "acs1", "acs1", "acs1", "acs1", "acs1", "acs1", "acs1", "ac…
## $ year       &lt;chr&gt; "2017", "2017", "2017", "2017", "2017", "2017", "2017", "20…
## $ var_code   &lt;chr&gt; "RT", "RT", "SERIALNO", "DIVISION", "DIVISION", "DIVISION",…
## $ var_label  &lt;chr&gt; "Record Type", "Record Type", "Housing unit/GQ person seria…
## $ data_type  &lt;chr&gt; "chr", "chr", "chr", "chr", "chr", "chr", "chr", "chr", "ch…
## $ level      &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ val_min    &lt;chr&gt; "H", "P", "2017000000001", "0", "1", "2", "3", "4", "5", "6…
## $ val_max    &lt;chr&gt; "H", "P", "2017999999999", "0", "1", "2", "3", "4", "5", "6…
## $ val_label  &lt;chr&gt; "Housing Record or Group Quarters Unit", "Person Record", "…
## $ recode     &lt;lgl&gt; TRUE, TRUE, FALSE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE…
## $ val_length &lt;int&gt; 1, 1, 13, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1, 1, 1, 2…
## $ val_na     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…</code></pre>
<p>Here we make <code>US_pums</code> contain age, sex, and income data for every single person in PUMS. <code>AGEP</code> is age, <code>FINCP</code> is income, and <code>SEX</code> is sex.</p>
<div class="sourceCode" id="cb1066"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">US_pums</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_pums.html">get_pums</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AGEP"</span>, <span class="st">"FINCP"</span>, <span class="st">"SEX"</span><span class="op">)</span>,
                    state <span class="op">=</span> <span class="va">state.name</span>,
                    recode <span class="op">=</span> <span class="cn">TRUE</span>,
                    survey <span class="op">=</span> <span class="st">"acs1"</span><span class="op">)</span></code></pre></div>
<!-- DK: below discussion is awkward. Also, I don't like not looking at the data. But this data is too big to upload, so I am just ignoring the issue for now. The data is in other/data/us_pums.rds if we want to work with it. -->
<p>Because we are using every single individual in PUMS to make <code>US_pums</code>, we get an enormous tibble with over 3 million rows! This might look intimidating at first, but we can use the same basic <strong>dplyr</strong> functions as usual.</p>
<p>One trade-off with using PUMS data as compared to aggregated data is that you only get the state and public use microdata area (PUMA) of each individual in the microdata. PUMAs are Census geographies that contain at least 100,000 people and are entirely within a single state. They are built from census tracts and counties and may or may not be similar to other recognized geographic boundaries. In New York City, for instance, PUMAs are closely aligned to Community Districts. So, if you are interested in pulling data about block groups, census tracts, or other small areas, you can’t use PUMS data. <code><a href="https://rdrr.io/pkg/tidycensus/man/get_pums.html">get_pums()</a></code> will always return <code>SERIALNO</code>, <code>SPORDER</code>, <code>WGTP</code>, <code>PWGTP</code>, and <code>ST</code>. <code>SERIALNO</code> and <code>SPORDER</code> are the variables that uniquely identify observations, <code>WGTP</code> and <code>PWGTP</code> are the housing-unit and person weights, and <code>ST</code> is the state code.</p>
<p>By setting <code>recode = TRUE</code>, we create new <code>_label</code> columns to recode these numerical values into what they represent.</p>
</div>
<div id="plotting-with-pums" class="section level2 unnumbered">
<h2>Plotting with PUMS<a class="anchor" aria-label="anchor" href="#plotting-with-pums"><i class="fas fa-link"></i></a>
</h2>
<p>But why is PUMS useful? Well, it allows us to create new interesting variables.</p>
<p>Let’s try making a map with PUMS. Let’s say we wanted to make a map of the percentage of the population of states in the Northwest that are seniors, which we will define as the percent of the population that is 65 or above. Although there’s no variable that will tell us this directly, we can use PUMS to construct it. We want our data to be as detailed as possible, so we will map our data by PUMAs. We define states in the northwest as Washington, Idaho, and Oregon.</p>
<p>First, we want to put your custom PUMS estimates on a map. To do this, let’s use the <strong>tigris</strong> package to download PUMA boundaries for the states in the northwest as an sf object.</p>
<div class="sourceCode" id="cb1067"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nw_states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"OR"</span>, <span class="st">"WA"</span>, <span class="st">"ID"</span><span class="op">)</span>
<span class="va">nw_pumas</span> <span class="op">&lt;-</span> <span class="fu">map</span><span class="op">(</span><span class="va">nw_states</span>, 
                <span class="fu">tigris</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/tigris/man/pumas.html">pumas</a></span>, 
                class <span class="op">=</span> <span class="st">"sf"</span>, 
                cb <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">reduce</span><span class="op">(</span><span class="va">rbind</span><span class="op">)</span></code></pre></div>
<p>Now, we use <code><a href="https://rdrr.io/pkg/tidycensus/man/get_pums.html">get_pums()</a></code> to get our data. We select <code>PUMA</code> and <code>AGEP</code>, which stand for PUMA and age respectively.</p>
<div class="sourceCode" id="cb1068"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nw_pums</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_pums.html">get_pums</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PUMA"</span>, <span class="st">"AGEP"</span><span class="op">)</span>,
                    state <span class="op">=</span> <span class="va">nw_states</span>,
                    recode <span class="op">=</span> <span class="cn">TRUE</span>,
                    survey <span class="op">=</span> <span class="st">"acs1"</span>,
                    year <span class="op">=</span> <span class="fl">2018</span><span class="op">)</span></code></pre></div>
<p>Now, we use <code>dplyr:group_by()</code> and <code>dplyr:summarize()</code> to make a modified version of <code>nw_pums</code> with new variables. <code>total_pop</code> represents the total population of a PUMA, and <code>pct_Senior</code> represents the fraction of the population in that PUMA that’s 65 or over (&gt;64).</p>
<div class="sourceCode" id="cb1069"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nw_Senior</span> <span class="op">&lt;-</span> <span class="va">nw_pums</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">ST</span>, <span class="va">PUMA</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">summarize</span><span class="op">(</span>total_pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">PWGTP</span><span class="op">)</span>, 
              pct_Senior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">PWGTP</span><span class="op">[</span><span class="va">AGEP</span> <span class="op">&gt;</span> <span class="fl">64</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">total_pop</span>,
              .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></code></pre></div>
<p>Working with PUMS data can be little tricky, so before we get to mapping we have to <code>left_join()</code> <code>nw_Senior</code> back into <code>nw_pums</code>, mapping <code>"STATEFP10"</code> to <code>ST</code>, and <code>"PUMACE10"</code> to <code>"PUMA"</code>. This is a confusing quirk of PUMS data that you do not need to worry about.</p>
<div class="sourceCode" id="cb1070"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nw_final</span> <span class="op">&lt;-</span> <span class="va">nw_pumas</span> <span class="op">%&gt;%</span>
    <span class="fu">left_join</span><span class="op">(</span><span class="va">nw_Senior</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"STATEFP10"</span> <span class="op">=</span> <span class="st">"ST"</span>, <span class="st">"PUMACE10"</span> <span class="op">=</span> <span class="st">"PUMA"</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<p>Then, we use <code>geom_sf()</code> to make our plot. We use <code>scale_fill_viridis_b(option = "magma")</code> and <code>theme_void()</code> to customize the look of our map, and use <code>labels = scales::label_percent(1))</code> as a handy trick to convert <code>pct_Senior</code>’s fractions into percentages. Add some <code>labs()</code> and we’re done!</p>
<div class="sourceCode" id="cb1071"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nw_final</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">pct_Senior</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">scale_fill_viridis_b</span><span class="op">(</span>name <span class="op">=</span> <span class="cn">NULL</span>,
        option <span class="op">=</span> <span class="st">"magma"</span>,
        labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_percent.html">label_percent</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Percentage of population that are Seniors"</span>,
         caption <span class="op">=</span> <span class="st">"Source: American Community Survey 2014-2018"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-887-1.png" width="100%"></div>
</div>
<div id="want-to-explore-further" class="section level2 unnumbered">
<h2>Want to explore further?<a class="anchor" aria-label="anchor" href="#want-to-explore-further"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>Take a look at the <a href="https://walkerke.github.io/tidycensus/"><strong>tidycensus</strong> website</a>.</li>
<li>If you have shapefiles from a place other than <strong>tidycensus</strong>, you can read them in using <code>st_read()</code> in the <strong>sf</strong> package, join them with other data using <strong>dplyr</strong> functions, and then map them with <code>geom_sf()</code> as we have shown above.
<ul>
<li>You may have to look into using <a href="https://ggplot2.tidyverse.org/reference/ggsf.html"><code>coord_sf()</code></a> if you have trouble displaying your data.</li>
</ul>
</li>
<li>Want to add interactivity to your maps? Check out the <strong>leaflet</strong> package. <a href="https://juliasilge.com/blog/using-tidycensus/">Here’s</a> a good introduction to using <strong>leaflet</strong> with <strong>tidycensus</strong>.</li>
<li>Practice your skills with <a href="https://andrewbtran.github.io/NICAR/2019/mapping/02_case_study_slides.html">Andrew Tran’s case study slides</a>, where you can replicate a graphic from the Washington Post. Note: this involves some packages we haven’t shown you in this book, but if you follow along step by step you will be able to see how they are used.</li>
</ul>
<p>Downloading feature geometry from the Census website. To cache shapefiles for use in future sessions, set <code><a href="https://rdrr.io/r/base/options.html">options(tigris_use_cache = TRUE)</a></code>.</p>

</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="functions.html">Functions</a></div>
<div class="next"><a href="ipums.html">IPUMS</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#maps">Maps</a></li>
<li><a class="nav-link" href="#tidycensus">Tidycensus</a></li>
<li>
<a class="nav-link" href="#conceptual-introduction-to-mapping">Conceptual introduction to mapping</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#vector-versus-spatial-data">Vector versus spatial data</a></li>
<li><a class="nav-link" href="#sf-vs-sp">sf vs sp</a></li>
<li><a class="nav-link" href="#shapefiles">Shapefiles</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#mapping-with-tidycensus-and-geom_sf">Mapping with tidycensus and geom_sf()</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#making-maps-pretty">Making maps pretty</a></li>
<li><a class="nav-link" href="#adding-back-alaska-and-hawaii">Adding back Alaska and Hawaii</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#faceting-maps">Faceting maps</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#transforming-and-mapping-the-data">Transforming and mapping the data</a></li></ul>
</li>
<li><a class="nav-link" href="#working-with-big-data">Working with big data</a></li>
<li><a class="nav-link" href="#pums">PUMS</a></li>
<li><a class="nav-link" href="#plotting-with-pums">Plotting with PUMS</a></li>
<li><a class="nav-link" href="#want-to-explore-further">Want to explore further?</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/PPBDS/primer/blob/master/maps.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/PPBDS/primer/edit/master/maps.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Preceptor’s Primer for Bayesian Data Science</strong>" was written by David Kane. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
